UserInputService = game:GetService("UserInputService")
RunService = game:GetService("RunService")

local ESPZombiesT = false
local billboardGuis = {}
local AutorepairT = false

function addText()
    local zombiesFolder = game.Workspace.Zombies
    for _, zombieModel in pairs(zombiesFolder:GetChildren()) do
        if zombieModel:IsA("Model") then
            local primaryPart = zombieModel.PrimaryPart
            if primaryPart then
                local billboardGui = Instance.new("BillboardGui")
                billboardGui.Adornee = primaryPart
                billboardGui.AlwaysOnTop = true
                billboardGui.Size = UDim2.new(0, 200, 0, 50)
                billboardGui.StudsOffset = Vector3.new(0, 4, 0)

                local textLabel = Instance.new("TextLabel")
                textLabel.Parent = billboardGui
                textLabel.BackgroundTransparency = 1
                textLabel.Size = UDim2.new(1, 0, 1, 0)
                textLabel.TextColor3 = Color3.new(0, 1, 1)
                textLabel.Font = Enum.Font.SourceSans
                textLabel.TextSize = 20

                local zombieType = zombieModel:GetAttribute("Type")
                if zombieType == "Normal" then
                    textLabel.Text = "僵尸"
                elseif zombieType == "Barrel" then
                    textLabel.Text = "自爆僵尸"
                    textLabel.TextColor3 = Color3.new(1, 0, 0)
                elseif zombieType == "Fast" then
                    textLabel.Text = "红眼"
                    textLabel.TextColor3 = Color3.new(1, 0, 0)
                elseif zombieType == "Sapper" then
                    textLabel.Text = "大师兄"
                elseif zombieType == "Igniter" then
                    textLabel.Text = "提灯人"
                end
                billboardGui.Parent = primaryPart
                table.insert(billboardGuis, billboardGui)
            end
        end
    end
end

function removeText()
    for _, billboardGui in pairs(billboardGuis) do
        billboardGui:Destroy()
    end
end

function ESPZombies()
    while ESPZombiesT == true do
        addText()
        wait(1)
        removeText()
    end
end

function Autorepair()
    while AutorepairT == true do
        local Players = game:GetService("Players")
        local localPlayer = Players.LocalPlayer
        local workspace = game:GetService("Workspace")
        local camera = workspace.CurrentCamera
        local character = localPlayer.Character
        local playerId = tostring(localPlayer.UserId)
        local buildingsFolder = workspace:FindFirstChild("Buildings")
        local playerSpecificFolder = buildingsFolder:FindFirstChild(playerId)

        local minDistance = math.huge
        local nearestBuildingHealth = nil

        local screenCenterX = camera.ViewportSize.X / 2
        local screenCenterY = camera.ViewportSize.Y / 2

        for _, model in ipairs(playerSpecificFolder:GetChildren()) do
            if model:IsA("Model") then
                local buildingHealth = model:FindFirstChild("BuildingHealth")
                if buildingHealth then
                    local hitbox = model:FindFirstChild("Hitbox")
                    if hitbox then
                        local screenPosition, onScreen = camera:WorldToScreenPoint(hitbox.CFrame.Position)
                        if onScreen then
                            local distance = (Vector2.new(screenPosition.X, screenPosition.Y) - Vector2.new(screenCenterX, screenCenterY)).Magnitude
                            if distance < minDistance then
                                minDistance = distance
                                nearestBuildingHealth = buildingHealth
                            end
                        end
                    end
                end
            end
        end

        local caltrops = workspace:FindFirstChild("Caltrops")
        if caltrops and caltrops:IsA("Model") then
            local buildingHealth = caltrops:FindFirstChild("BuildingHealth")
            if buildingHealth then
                local hitbox = caltrops:FindFirstChild("Hitbox")
                if hitbox then
                    local screenPosition, onScreen = camera:WorldToScreenPoint(hitbox.CFrame.Position)
                    if onScreen then
                        local distance = (Vector2.new(screenPosition.X, screenPosition.Y) - Vector2.new(screenCenterX, screenCenterY)).Magnitude
                        if distance < minDistance then
                            minDistance = distance
                            nearestBuildingHealth = buildingHealth
                        end
                    end
                end
            end
        end

        local stakes = workspace:FindFirstChild("Stakes")
        if stakes and stakes:IsA("Model") then
            local buildingHealth = stakes:FindFirstChild("BuildingHealth")
            if buildingHealth then
                local hitbox = stakes:FindFirstChild("Hitbox")
                if hitbox then
                    local screenPosition, onScreen = camera:WorldToScreenPoint(hitbox.CFrame.Position)
                    if onScreen then
                        local distance = (Vector2.new(screenPosition.X, screenPosition.Y) - Vector2.new(screenCenterX, screenCenterY)).Magnitude
                        if distance < minDistance then
                            minDistance = distance
                            nearestBuildingHealth = buildingHealth
                        end
                    end
                end
            end
        end

        if nearestBuildingHealth then
            local args = {
                [1] = "Repair",
                [2] = nearestBuildingHealth
            }
            local hammer = character:FindFirstChild("Hammer")
            if hammer then
                local remoteEvent = hammer:FindFirstChild("RemoteEvent")
                if remoteEvent then
                    remoteEvent:FireServer(unpack(args))
                end
            end
        end
        task.wait()
    end
end

local Rayfield = loadstring(game:HttpGet("https://gitee.com/roblox-smk/rayfield/raw/master/Rayfield"))()

local Window =
    Rayfield:CreateWindow(
    {
        Name = "宿傩脚本",
        Icon = 0,
        LoadingTitle = "加载中",
        LoadingSubtitle = "宿傩制作",
        Theme = "Default",
        DisableRayfieldPrompts = false,
        DisableBuildWarnings = false,
        ConfigurationSaving = {
            Enabled = false,
            FolderName = nil,
            FileName = ""
        },
        Discord = {
            Enabled = false,
            Invite = "",
            RememberJoins = true
        },
        KeySystem = false,
        KeySettings = {
            Title = "",
            Subtitle = "",
            Note = "",
            FileName = "",
            SaveKey = true,
            GrabKeyFromSite = false,
            Key = {""}
        }
    }
)

local MainTab = Window:CreateTab("主页")

local Button =
    MainTab:CreateButton(
    {
        Name = "关闭",
        Callback = function()
            Rayfield:Destroy()
        end
    }
)

local tpwalking
local Noclipping
local flyjump
local drawUserNamesT
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local billboardGuis = {}
local function onPlayerAdded(player)
    local function onCharacterAdded(character)
        local head = character:FindFirstChild("Head")
        if head then
            local billboardGui = Instance.new("BillboardGui")
            billboardGui.Parent = head
            billboardGui.AlwaysOnTop = true
            billboardGui.Size = UDim2.new(0, 200, 0, 50)
            billboardGui.StudsOffset = Vector3.new(0, 3, 0)
            local textLabel = Instance.new("TextLabel")
            textLabel.Parent = billboardGui
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.TextColor3 = Color3.new(1, 1, 1)
            textLabel.Font = Enum.Font.SourceSansBold
            textLabel.TextSize = 14
            textLabel.TextStrokeTransparency = 0.3
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
            textLabel.Text = player.Name
            table.insert(billboardGuis, billboardGui)
        end
    end
    player.CharacterAdded:Connect(onCharacterAdded)
end

local function Drawusernames()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            local character = player.Character
            if character then
                local head = character:FindFirstChild("Head")
                if head then
                    local billboardGui = Instance.new("BillboardGui")
                    billboardGui.Parent = head
                    billboardGui.AlwaysOnTop = true
                    billboardGui.Size = UDim2.new(0, 200, 0, 50)
                    billboardGui.StudsOffset = Vector3.new(0, 6, 0)
                    local textLabel = Instance.new("TextLabel")
                    textLabel.Parent = billboardGui
                    textLabel.Size = UDim2.new(1, 0, 1, 0)
                    textLabel.BackgroundTransparency = 1
                    textLabel.TextColor3 = Color3.new(1, 1, 1)
                    textLabel.Font = Enum.Font.SourceSansBold
                    textLabel.TextSize = 14
                    textLabel.TextStrokeTransparency = 0.3
                    textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
                    textLabel.Text = player.Name
                    table.insert(billboardGuis, billboardGui)
                end
            end
        end
    end
end

local function RemoveDrawusernames()
    for _, gui in pairs(billboardGuis) do
        gui:Destroy()
    end
    billboardGuis = {}
end

local GutsBlackpowder = Window:CreateTab("内脏与黑火药")

local Section = GutsBlackpowder:CreateSection("先开加速再输入速度，想变慢加速重开重新输入速度")

local Input =
    GutsBlackpowder:CreateInput(
    {
        Name = "加速速度|TpwalkSpeed",
        CurrentValue = "",
        PlaceholderText = "",
        RemoveTextAfterFocusLost = false,
        Flag = "",
        Callback = function(Text)
            local hb = RunService.Heartbeat
            local chr = localPlayer.Character
            local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
            local args = {Text}
            while tpwalking and chr and hum and hum.Parent do
                local delta = hb:wait()
                if hum.MoveDirection.Magnitude > 0 then
                    if args[1] and tonumber(args[1]) then
                        chr:TranslateBy(hum.MoveDirection * tonumber(args[1]) * delta * 10)
                    else
                        chr:TranslateBy(hum.MoveDirection * delta * 10)
                    end
                end
            end
        end
    }
)

local Toggle =
    GutsBlackpowder:CreateToggle(
    {
        Name = "加速|Tpwalk",
        CurrentValue = false,
        Flag = "",
        Callback = function(Value)
            tpwalking = Value
        end
    }
)

local Toggle =
    GutsBlackpowder:CreateToggle(
    {
        Name = "穿墙|Noclip",
        CurrentValue = false,
        Flag = "",
        Callback = function(Value)
            if Value == true then
                Clip = false
                task.wait()
                local function NoclipLoop()
                    if Clip == false and localPlayer.Character ~= nil then
                        for _, child in pairs(localPlayer.Character:GetDescendants()) do
                            if child:IsA("BasePart") and child.CanCollide == true and child.Name ~= floatName then
                                child.CanCollide = false
                            end
                        end
                    end
                end
                Noclipping = RunService.Stepped:Connect(NoclipLoop)
            else
                if Noclipping then
                    Noclipping:Disconnect()
                end
                Clip = true
            end
        end
    }
)

local Toggle =
    GutsBlackpowder:CreateToggle(
    {
        Name = "连跳|Flyjump",
        CurrentValue = false,
        Flag = "",
        Callback = function(Value)
            if Value == true then
                if flyjump then
                    flyjump:Disconnect()
                end
                flyjump =
                    UserInputService.JumpRequest:Connect(
                    function()
                        localPlayer.Character:FindFirstChildWhichIsA("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                )
            else
                if flyjump then
                    flyjump:Disconnect()
                end
            end
        end
    }
)

local Button =
    GutsBlackpowder:CreateButton(
    {
        Name = "飞行|Fly",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/Sukuna2134/Script/refs/heads/main/Fly"))()
        end
    }
)

local Section = GutsBlackpowder:CreateSection("自瞄默认僵尸可见才锁")
local Section = GutsBlackpowder:CreateSection("自瞄、子追、自动维修默认追踪屏幕中心最近目标")

local button =
    GutsBlackpowder:CreateButton(
    {
        Name = "夜视",
        Callback = function()
            game:GetService("Players").LocalPlayer.Options.Brightness.Value = 0.5
        end
    }
)

local Button =
    GutsBlackpowder:CreateButton(
    {
        Name = "全枪子追",
        Callback = function()
            local screenGui = Instance.new("ScreenGui")
            screenGui.Parent = game:GetService("CoreGui")
            local toggleButton = Instance.new("TextButton")
            toggleButton.Parent = screenGui
            toggleButton.Size = UDim2.new(0, 150, 0, 50)
            toggleButton.Position = UDim2.new(0, 100, 0, 100)
            toggleButton.Text = "开火"
            toggleButton.Draggable = true

            local function isPlayerVisible(targetPlayer)
                if not targetPlayer or not targetPlayer:FindFirstChild("Head") then
                    return false
                end
                if teamCheckActive and targetPlayer.Team == localPlayer.Team then
                    return false
                end
                local targetHeadPosition = targetPlayer.Head.Position
                local vectorToTarget = (targetHeadPosition - camera.CFrame.Position).unit
                local ray = Ray.new(camera.CFrame.Position, vectorToTarget * fovRadius)
                local part, position = game.Workspace:FindPartOnRay(ray, localPlayer.Character, false, true)
                if part and part:IsDescendantOf(targetPlayer) then
                    local dotProduct = camera.CFrame.LookVector:Dot(vectorToTarget)
                    local angle = math.deg(math.acos(dotProduct))
                    return angle <= (fovRadius / 2)
                end
                return false
            end

            toggleButton.MouseButton1Click:Connect(
                function()
                    local player = game:GetService("Players").LocalPlayer
                    local character = player.Character
                    if not character then
                        return
                    end

                    local camera = workspace.CurrentCamera

                    local zombiesFolder = workspace:FindFirstChild("Zombies")
                    if not zombiesFolder then
                        return
                    end

                    local minDistance = math.huge
                    local nearestZombie = nil

                    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
                        if zombie:IsA("Model") and zombie.PrimaryPart then
                            local screenPosition, onScreen = camera:WorldToScreenPoint(zombie.PrimaryPart.Position)
                            if onScreen then
                                local screenCenterX = camera.ViewportSize.X / 2
                                local screenCenterY = camera.ViewportSize.Y / 2
                                local distance = (Vector2.new(screenPosition.X, screenPosition.Y) - Vector2.new(screenCenterX, screenCenterY)).Magnitude
                                if distance < minDistance then
                                    minDistance = distance
                                    nearestZombie = zombie
                                end
                            end
                        end
                    end

                    if nearestZombie then
                        local args = {
                            [1] = "Fire",
                            [2] = character.Model,
                            [3] = nearestZombie.PrimaryPart.Position,
                            [4] = 1
                        }
                        local tool = character:FindFirstChildWhichIsA("Tool")

                        if tool and tool:FindFirstChild("RemoteEvent") then
                            tool.RemoteEvent:FireServer(unpack(args))
                        end
                    end
                end
            )

            local function onTouchStarted(touch)
                currentTouch = touch.Position
                fovCircleGui.Position = UDim2.new(0, touch.Position.X - fovRadius, 0, touch.Position.Y - fovRadius)
                fovCircleGui.Visible = true
            end

            local function onTouchEnded(touch)
                if currentTouch and currentTouch == touch.Position then
                    currentTouch = nil
                    fovCircleGui.Visible = false
                end
            end

            UserInputService.TouchStarted:Connect(onTouchStarted)
            UserInputService.TouchEnded:Connect(onTouchEnded)

            screenGui.Enabled = true

            RunService.RenderStepped:Connect(
                function()
                    if lockOnActive then
                        for _, player in ipairs(workspace.Zombies:GetDescendants()) do
                            if isPlayerVisible(player) then
                                local head = player.Head
                                local direction = (head.Position - camera.CFrame.Position).unit
                                camera.CFrame = CFrame.new(camera.CFrame.Position, camera.CFrame.Position + direction * 10)
                                break
                            end
                        end
                    end
                end
            )
        end
    }
)

local Button =
    GutsBlackpowder:CreateButton(
    {
        Name = "僵尸自瞄（手机）",
        Callback = function()
            local Players = game:GetService("Players")
            local UserInputService = game:GetService("UserInputService")
            local RunService = game:GetService("RunService")
            local localPlayer = Players.LocalPlayer
            local camera = game.Workspace.CurrentCamera
            local lockOnActive = false
            local teamCheckActive = false
            local currentTouch = nil
            local fovRadius = 125
            local screenGui = Instance.new("ScreenGui")
            screenGui.Parent = game:GetService("CoreGui")
            local toggleButton = Instance.new("TextButton")
            toggleButton.Parent = screenGui
            toggleButton.Size = UDim2.new(0, 150, 0, 50)
            toggleButton.Position = UDim2.new(0, 100, 0, 100)
            toggleButton.Text = "开启"
            toggleButton.Draggable = true
            local fovCircleGui = Instance.new("ImageLabel")
            fovCircleGui.Parent = screenGui
            fovCircleGui.AnchorPoint = Vector2.new(0.5, 0.5)
            fovCircleGui.Size = UDim2.new(0, fovRadius * 2, 0, fovRadius * 2)
            fovCircleGui.Image = "rbxassetid://432312433"
            fovCircleGui.ImageTransparency = 0.5
            fovCircleGui.ImageColor3 = Color3.new(1, 1, 1)
            fovCircleGui.BackgroundTransparency = 1
            fovCircleGui.Visible = false
            fovCircleGui.ZIndex = 0

            local function isPlayerVisible(targetPlayer)
                if not targetPlayer or not targetPlayer:FindFirstChild("Head") then
                    return false
                end
                if teamCheckActive and targetPlayer.Team == localPlayer.Team then
                    return false
                end
                local targetHeadPosition = targetPlayer.Head.Position
                local vectorToTarget = (targetHeadPosition - camera.CFrame.Position).unit
                local ray = Ray.new(camera.CFrame.Position, vectorToTarget * fovRadius)
                local part, position = game.Workspace:FindPartOnRay(ray, localPlayer.Character, false, true)
                if part and part:IsDescendantOf(targetPlayer) then
                    local dotProduct = camera.CFrame.LookVector:Dot(vectorToTarget)
                    local angle = math.deg(math.acos(dotProduct))
                    return angle <= (fovRadius / 2)
                end
                return false
            end

            toggleButton.MouseButton1Click:Connect(
                function()
                    lockOnActive = not lockOnActive
                    toggleButton.Text = lockOnActive and "关闭" or "开启"
                    fovCircleGui.Visible = lockOnActive
                end
            )

            local function onTouchStarted(touch)
                currentTouch = touch.Position
                fovCircleGui.Position = UDim2.new(0, touch.Position.X - fovRadius, 0, touch.Position.Y - fovRadius)
                fovCircleGui.Visible = true
            end

            local function onTouchEnded(touch)
                if currentTouch and currentTouch == touch.Position then
                    currentTouch = nil
                    fovCircleGui.Visible = false
                end
            end

            UserInputService.TouchStarted:Connect(onTouchStarted)
            UserInputService.TouchEnded:Connect(onTouchEnded)

            screenGui.Enabled = true

            RunService.RenderStepped:Connect(
                function()
                    if lockOnActive then
                        for _, player in ipairs(workspace.Zombies:GetDescendants()) do
                            if isPlayerVisible(player) then
                                local head = player.Head
                                local direction = (head.Position - camera.CFrame.Position).unit
                                camera.CFrame = CFrame.new(camera.CFrame.Position, camera.CFrame.Position + direction * 10)
                                break
                            end
                        end
                    end
                end
            )
        end
    }
)

local Button =
    GutsBlackpowder:CreateButton(
    {
        Name = "僵尸自瞄（右键）",
        Callback = function()
            local Players = game:GetService("Players")
            local UserInputService = game:GetService("UserInputService")
            local RunService = game:GetService("RunService")
            local localPlayer = Players.LocalPlayer
            local camera = game.Workspace.CurrentCamera

            local fovRadius = 125

            local isRightMouseDown = false

            local function isZombieVisible(zombie)
                if not zombie or not zombie:FindFirstChild("Head") then
                    return false
                end
                local targetHeadPosition = zombie.Head.Position
                local vectorToTarget = (targetHeadPosition - camera.CFrame.Position).unit
                local ray = Ray.new(camera.CFrame.Position, vectorToTarget * fovRadius)
                local part, position = game.Workspace:FindPartOnRay(ray, localPlayer.Character, false, true)
                if part and part:IsDescendantOf(zombie) then
                    local dotProduct = camera.CFrame.LookVector:Dot(vectorToTarget)
                    local angle = math.deg(math.acos(dotProduct))
                    return angle <= (fovRadius / 2)
                end
                return false
            end

            UserInputService.InputBegan:Connect(
                function(input, gameProcessedEvent)
                    if input.UserInputType == Enum.UserInputType.MouseButton2 and not gameProcessedEvent then
                        isRightMouseDown = true
                    end
                end
            )

            UserInputService.InputEnded:Connect(
                function(input, gameProcessedEvent)
                    if input.UserInputType == Enum.UserInputType.MouseButton2 and not gameProcessedEvent then
                        isRightMouseDown = false
                    end
                end
            )

            RunService.RenderStepped:Connect(
                function()
                    if isRightMouseDown then
                        local closestZombie = nil
                        local closestDistance = math.huge
                        local zombiesFolder = workspace:FindFirstChild("Zombies")
                        if zombiesFolder then
                            for _, zombie in ipairs(zombiesFolder:GetChildren()) do
                                if isZombieVisible(zombie) then
                                    local head = zombie.Head
                                    local distance = (head.Position - camera.CFrame.Position).Magnitude
                                    if distance < closestDistance then
                                        closestDistance = distance
                                        closestZombie = zombie
                                    end
                                end
                            end
                        end

                        if closestZombie then
                            local head = closestZombie.Head
                            local direction = (head.Position - camera.CFrame.Position).unit
                            camera.CFrame = CFrame.new(camera.CFrame.Position, camera.CFrame.Position + direction * 10)
                        end
                    end
                end
            )
        end
    }
)

local toggle =
    GutsBlackpowder:CreateToggle(
    {
        Name = "透视僵尸",
        CurrentValue = false,
        Flag = "",
        Callback = function(Value)
            ESPZombiesT = Value
            ESPZombies()
        end
    }
)

local toggle =
    GutsBlackpowder:CreateToggle(
    {
        Name = "自动维修",
        CurrentValue = false,
        Flag = "",
        Callback = function(Value)
            AutorepairT = Value
            Autorepair()
        end
    }
)